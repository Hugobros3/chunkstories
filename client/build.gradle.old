// Apply the java plugin to add support for Java
apply plugin: 'java'

// Apply the application plugin to add support for building an application
apply plugin: 'application'

apply plugin: 'maven'

//Make this into a shadow jar
buildscript {
    repositories {
        jcenter()
    }
    dependencies {
        classpath 'com.github.jengelman.gradle.plugins:shadow:4.0.2'
    }
}

apply plugin: 'com.github.johnrengelman.shadow'

version = rootProject.version
description = 'Multiplatform PC Client using LWJGL3'

// Dependencies from subprojects
dependencies {
	compile project(':common')
	compile project(':server')
}

dependencies {
	compile "guru.nidi:graphviz-java:0.8.0"

	ext.spirvCrossVersion = "0.5.0-1.1.85"
	compile "graphics.scenery:spirvcrossj:$spirvCrossVersion"

	compile "org.lwjgl:lwjgl-glfw:${rootProject.ext.lwjglVersion}"
	//compile "org.lwjgl:lwjgl-jemalloc:${rootProject.ext.lwjglVersion}"
	compile "org.lwjgl:lwjgl-openal:${rootProject.ext.lwjglVersion}"
	compile "org.lwjgl:lwjgl-opengl:${rootProject.ext.lwjglVersion}"
	compile "org.lwjgl:lwjgl-vulkan:${rootProject.ext.lwjglVersion}"
	compile "org.lwjgl:lwjgl-stb:${rootProject.ext.lwjglVersion}"
	compile "org.lwjgl:lwjgl-tinyfd:${rootProject.ext.lwjglVersion}"
	compile "org.lwjgl:lwjgl-vma:${rootProject.ext.lwjglVersion}"

	//When running on our debug computer, it's safe to assume the OS that will run the game is the same than the one who'll compile it.
	/*runtime "org.lwjgl:lwjgl-glfw:${rootProject.ext.lwjglVersion}:${rootProject.ext.lwjglNatives}"
	//runtime "org.lwjgl:lwjgl-jemalloc:${rootProject.ext.lwjglVersion}:${rootProject.ext.lwjglNatives}"
	runtime "org.lwjgl:lwjgl-openal:${rootProject.ext.lwjglVersion}:${rootProject.ext.lwjglNatives}"
	runtime "org.lwjgl:lwjgl-opengl:${rootProject.ext.lwjglVersion}:${rootProject.ext.lwjglNatives}"
	runtime "org.lwjgl:lwjgl-stb:${rootProject.ext.lwjglVersion}:${rootProject.ext.lwjglNatives}"
	runtime "org.lwjgl:lwjgl-tinyfd:${rootProject.ext.lwjglVersion}:${rootProject.ext.lwjglNatives}"
	runtime "org.lwjgl:lwjgl-vma:${rootProject.ext.lwjglVersion}:${rootProject.ext.lwjglNatives}"
	runtime "graphics.scenery:spirvcrossj:$spirvCrossVersion:$rootProject.ext.lwjglNatives"*/

	//When compiling a redistribuable jar, we need ALL natives in it!
	rootProject.ext.natives.each {
		runtime "org.lwjgl:lwjgl-glfw:${rootProject.ext.lwjglVersion}:$it"
		runtime "org.lwjgl:lwjgl-openal:${rootProject.ext.lwjglVersion}:$it"
		runtime "org.lwjgl:lwjgl-opengl:${rootProject.ext.lwjglVersion}:$it"
		runtime "org.lwjgl:lwjgl-stb:${rootProject.ext.lwjglVersion}:$it"
		runtime "org.lwjgl:lwjgl-tinyfd:${rootProject.ext.lwjglVersion}:$it"
		runtime "org.lwjgl:lwjgl-vma:${rootProject.ext.lwjglVersion}:$it"
		runtime "graphics.scenery:spirvcrossj:$spirvCrossVersion:$it"
	}
}

// Define the main class for the application
mainClassName = 'xyz.chunkstories.client.ClientImplementation'

jar {
	manifest {
		attributes  'Implementation-Title': 'Chunk Stories Client',
					'Implementation-Version': version
	}
	
	classifier = 'bare'
}

processResources {
	dependsOn rootProject.versionTxt
}

shadowJar {
	baseName = 'chunkstories'
	classifier = null
	version = null
	configurations = [project.configurations.runtime]
}

run { 
	doFirst {
		/* Need to split the space-delimited value in the exec.args */
		println "Running client; Setting project dir : " + rootProject.projectDir
		workingDir = rootProject.projectDir
		args = [new String("--dir="+rootProject.projectDir), new String("--core=" + rootProject.ext.actualContentLocation)]
		println args
	}

	//Depends on the core content being present.
	afterEvaluate {
		dependsOn(':common:setupContentLocation')
	}
}

//We want to be able to publish artifacts of the client, even if we don't bundle the source.

//Create a properties.gradle with login credentials to use this.
//Watch out: wagon-ssh is an old mess and WILL NOT TAKE EdDSA host keys
//You MUST ask the server for one of those and replace whatever you had for it in known_hosts
/*if(hasProperty('uploadUsername')) {
	println 'Login credentials found'
	uploadArchives {
		repositories {
				mavenDeployer {
       				configuration = configurations.deployerJars	
					
					if(project.hasProperty('uploadPrivateKey')) {
						println 'Found private key'
						repository(url: "scp://xol.io/home/maven-user/maven-repo") {				
							authentication(userName: uploadUsername, privateKey: uploadPrivateKey)
		    				}
					}
					else {
						println 'Found password'
						repository(url: "scp://xol.io/home/maven-user/maven-repo") {				
							authentication(userName: uploadUsername, password: uploadPassword)
		    				}
					}
				}
		}
	}
}

configurations.archives.with { artifacts.remove artifacts.find { it.archiveTask.is distZip } } 
configurations.archives.with { artifacts.remove artifacts.find { it.archiveTask.is distTar } } 
configurations.archives.with { artifacts.remove artifacts.find { it.archiveTask.is shadowDistZip } } 
configurations.archives.with { artifacts.remove artifacts.find { it.archiveTask.is shadowDistTar } } 
*/